comment: # {{ ansible_managed }}
worker_processes:  6
worker_rlimit_nofile: 50000
user: "{{ www_user }} {{ www_group }}"
events:
  use:
    value: epoll
    comment: essential for linux, optmized to serve many clients with each thread
  multi_accept:
    value: on
    comment: "Accept as many connections as possible, after nginx gets notification about a new connection. May flood worker_connections, if that option is set too low."
  worker_connections:  4096
http:
  includes:
    - include: mime.types
    - include: "/etc/nginx/conf.d/*.conf"
  default_type: application/octet-stream
  client_max_body_size: "{{ client_max_body_size_and_unit }}"
  log_format:  main  "'$remote_addr - $remote_user [$time_local] $ssl_protocol/$ssl_cipher"
  limit_req_zone:
    value: "$binary_remote_addr zone=one:10m rate={{ limit_req_per_sec }}r/s"
    condition_start: "{%- if is_rate_limited|default(False) and not rpc_server|default(False) and not maas_server|default(False)%}"
    condition_end: "{% endif %}"
  sendfile: on
  tcp_nopush: on
  tcp_nodelay: on
  client_header_timeout: 15
  client_body_timeout: 15
  send_timeout: 30
  reset_timedout_connection: on
  proxy_set_header: "Proxy \"\""
  keepalive_timeout: 15
  keepalive_requests: 20
  server_tokens: off
  gzip: on
  gzip_types: text/plain text/css application/x-javascript text/xml application/xml text/javascript application/rss+xml
  gzip_comp_level: 4
  gzip_vary: on
  gzip_proxied: any
  gzip_min_length: 256
  gzip_buffers: 16 8k
  gzip_disable: “MSIE [1-6].(?!.*SV1)”
  open_file_cache:
     value: max=10000 inactive=10s
     comment: "Caches information about open FDs, freqently accessed files."
  open_file_cache_valid: 30s
  open_file_cache_min_uses: 2
  open_file_cache_errors: on
  real_ip_header:
    value: X-Forwarded-For
    comment: "We sometimes have trusted proxies set the X-Forwarded-For header with the"
  set_real_ip_from:
    value: "{{ ip }}"
    condition_start: "{% for ip in xff_trusted_ips %}"
    condition_end: "{% endfor %}"
    comment: "real request IP."
    
  upstream:
    comment: "FOR FB HACK ONLY"
    upstream_name: secure
    server: "127.0.0.1:443 max_fails=1 fail_timeout=2s weight=1"
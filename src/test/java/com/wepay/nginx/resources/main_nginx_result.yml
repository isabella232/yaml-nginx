events {
    #Accept as many connections as possible, after nginx gets notification about a new connection. May flood worker_connections, if that option is set too low.
    multi_accept       true;
    #essential for linux, optmized to serve many clients with each thread
    use                epoll;
    worker_connections 4096;
}
http {
    include mime.types;
    include /etc/nginx/conf.d/*.conf;
    client_body_timeout       15;
    client_header_timeout     15;
    client_max_body_size      {{ client_max_body_size_and_unit }};
    default_type              application/octet-stream;
    gzip                      true;
    gzip_buffers              16 8k;
    gzip_comp_level           4;
    gzip_disable              “MSIE [1-6].(?!.*SV1)”;
    gzip_min_length           256;
    gzip_proxied              any;
    gzip_types                text/plain text/css application/x-javascript text/xml application/xml text/javascript application/rss+xml;
    gzip_vary                 true;
    keepalive_requests        20;
    keepalive_timeout         15;
    limit_req_zone            $binary_remote_addr zone=one:10m rate={{ limit_req_per_sec }}r/s;
    log_format                main  "'$remote_addr - $remote_user [$time_local] $ssl_protocol/$ssl_cipher";
    #Caches information about open FDs, freqently accessed files.
    open_file_cache           max=10000 inactive=10s;
    open_file_cache_errors    true;
    open_file_cache_min_uses  2;
    open_file_cache_valid     30s;
    proxy_set_header          Proxy "";
    #We sometimes have trusted proxies set the X-Forwarded-For header with the
    real_ip_header            X-Forwarded-For;
    reset_timedout_connection true;
    send_timeout              30;
    sendfile                  true;
    server_tokens             false;
    #real request IP.
    set_real_ip_from          {{ ip }};
    tcp_nodelay               true;
    tcp_nopush                true;
    #FOR FB HACK ONLY
    upstream secure {
        server 127.0.0.1:443 max_fails=1 fail_timeout=2s weight=1;
    }
}
user                 {{ www_user }} {{ www_group }};
worker_processes     6;
worker_rlimit_nofile 50000;
